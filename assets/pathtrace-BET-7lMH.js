import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css             */class h{static lerp(t,e,n){return(1-n)*t+e*n}static srgb_to_linear(t){return Math.pow(t,2.2)}static clamp01(t){return Math.min(Math.max(t,0),1)}}class w{static rand(){return Math.random()}static range(t,e){return t+(e-t)*this.rand()}}class s{constructor(t,e,n){this.x=t,this.y=e,this.z=n}add(t){return typeof t=="number"?new s(this.x+t,this.y+t,this.z+t):new s(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return typeof t=="number"?new s(this.x-t,this.y-t,this.z-t):new s(this.x-t.x,this.y-t.y,this.z-t.z)}mul(t){return new s(this.x*t,this.y*t,this.z*t)}mul_vec(t){return new s(this.x*t.x,this.y*t.y,this.z*t.z)}div(t){if(t===0)throw new Error("Can't div by 0");return new s(this.x/t,this.y/t,this.z/t)}sqr_mag(){return this.x*this.x+this.y*this.y+this.z*this.z}mag(){return Math.sqrt(this.sqr_mag())}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new s(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}normalize(){return this.div(this.mag())}reflect(t){return this.sub(t.mul(2*this.dot(t)))}refract(t,e){const n=this.normalize(),a=Math.min(n.mul(-1).dot(t),1),r=n.add(t.mul(a)).mul(e),i=t.mul(-Math.sqrt(Math.abs(1-r.sqr_mag())));return r.add(i)}near_zero(){return Math.abs(this.x)<1e-4&&Math.abs(this.y)<1e-4&&Math.abs(this.z)<1e-4}clamp01(){return new s(h.clamp01(this.x),h.clamp01(this.y),h.clamp01(this.z))}srgb_to_linear(){return new s(h.srgb_to_linear(this.x),h.srgb_to_linear(this.y),h.srgb_to_linear(this.z))}static lerp(t,e,n){return new s(h.lerp(t.x,e.x,n),h.lerp(t.y,e.y,n),h.lerp(t.z,e.z,n))}static zero(){return new s(0,0,0)}static one(){return new s(1,1,1)}static from_hex(t){const e=(t>>16&255)/255,n=(t>>8&255)/255,a=(t>>0&255)/255;return new s(e,n,a)}static random(){return new s(w.range(-1,1),w.range(-1,1),w.range(-1,1))}static random_in_unit_sphere(){for(;;){const t=this.random(),e=t.sqr_mag();if(!(e===0||e>=1))return t}}static random_unit_vector(){return this.random_in_unit_sphere().normalize()}static random_in_hemisphere(t){const e=this.random_in_unit_sphere();return e.dot(t)>0?e:e.mul(-1)}static random_cosine_direction(){const t=w.rand(),e=w.rand(),n=Math.sqrt(1-e),a=2*Math.PI*t,r=Math.cos(a)*Math.sqrt(e),i=Math.sin(a)*Math.sqrt(e);return new s(r,i,n)}static random_in_hemisphere_cosine(t){const e=t.normalize(),n=Math.abs(e.x)>.9?new s(0,1,0):new s(1,0,0),a=e.cross(n).normalize(),r=a.cross(e),i=this.random_cosine_direction();return r.mul(i.x).add(a.mul(i.y)).add(e.mul(i.z))}toString(){return`(${this.x}, ${this.y}, ${this.z})`}}class ct{constructor(t,e,n,a,r){this.distance=t,this.point=e,this.normal=n,this.front_face=a,this.material=r}}class z{constructor(t,e,n){this.pos=t,this.r=e,this.material=n}intersects(t){const e=t.origin.sub(this.pos),n=t.dir.dot(t.dir),a=2*e.dot(t.dir),r=e.dot(e)-this.r*this.r,i=a*a-4*n*r;if(i<0)return null;const c=Math.sqrt(i),m=(-a-c)/(2*n),y=(-a+c)/(2*n),_=1e-4;let p=Number.POSITIVE_INFINITY;if(m>_)p=m;else if(y>_)p=y;else return null;const k=t.origin.add(t.dir.mul(p)),I=k.sub(this.pos).mul(1/this.r).normalize(),j=t.dir.dot(I)<0,ot=j?I:I.mul(-1);return new ct(p,k,ot,j,this.material)}}class lt{constructor(t){this.shapes=t}hit(t,e=1e-4,n=Number.POSITIVE_INFINITY){let a=n,r=null;for(const i of this.shapes){const c=i.intersects(t);c&&c.distance>e&&c.distance<a&&(a=c.distance,r=c)}return r}}class L{constructor(t,e){this.origin=t,this.dir=e}at(t){return this.origin.add(this.dir.mul(t))}}class ${emitted(t){return s.zero()}}class S extends ${constructor(t){super(),this.albedo=t}scatter(t,e){let n=s.random_in_hemisphere_cosine(e.normal);n.near_zero()&&(n=e.normal);const r=e.point.add(e.normal.mul(1e-4));return new G(this.albedo,new L(r,n.normalize()))}}class ut extends ${constructor(t){super(),this.emission=t}emitted(t){return t.front_face?this.emission:s.zero()}scatter(t,e){return null}}class mt extends ${constructor(t,e=0){super(),this.albedo=t,this.fuzz=h.clamp01(e)}scatter(t,e){let a=t.dir.normalize().reflect(e.normal).add(s.random_in_unit_sphere().mul(this.fuzz));if(a.dot(e.normal)<=0)return null;const i=e.point.add(e.normal.mul(1e-4));return new G(this.albedo,new L(i,a.normalize()))}}class Y extends ${constructor(t){super(),this.ior=t}scatter(t,e){const n=s.one(),a=e.front_face?1/this.ior:this.ior,r=t.dir.normalize(),i=Math.min(r.mul(-1).dot(e.normal),1),c=Math.sqrt(1-i*i),m=a*c>1,y=Y.reflectance(i,a);let _;m||Math.random()<y?_=r.reflect(e.normal):_=r.refract(e.normal,a);const p=1e-4,k=_.dot(e.normal)>0?e.normal:e.normal.mul(-1),I=e.point.add(k.mul(p));return new G(n,new L(I,_.normalize()))}static reflectance(t,e){let n=(1-e)/(1+e);return n=n*n,n+(1-n)*Math.pow(1-t,5)}}class G{constructor(t,e){this.attenuation=t,this.ray=e}}class K{constructor(t,e,n,a,r){this.bounces=t,this.samples=e,this.gamma_correction=n,this.exposure=a,this.tone_map=r}static default(){return new K(20,10,!0,1,"aces")}}function dt(o,t,e,n,a,r,i){let c=s.zero();for(let m=0;m<i.samples;m++){const y=(o+w.rand())/e,_=(t+w.rand())/n,p=a.get_ray(y,_);c=c.add(Q(r,p,i.bounces))}return c=c.mul(1/i.samples),c}function Q(o,t,e,n){if(e<=0)return s.zero();const a=o.hit(t);if(!a)return ht(t);const r=a.material.emitted(a),i=a.material.scatter(t,a);return i?r.add(i.attenuation.mul_vec(Q(o,i.ray,e-1))):r}function ht(o){const t=o.dir.normalize(),e=new s(.3,.8,.6).normalize(),n=Math.max(0,t.dot(e)),a=Math.max(0,t.y),r=new s(.2,.45,.9),i=new s(.8,.6,.4),c=new s(1,.9,.6);let m=s.lerp(i,r,Math.pow(a,.5));return m=m.mul(.7+.3*a),m=m.add(c.mul(Math.pow(n,64))),m}class _t{constructor(t,e){const n=t*Math.PI/180,r=2*Math.tan(n/2),i=e*r;this.origin=new s(0,0,0),this.horizontal=new s(i,0,0),this.vertical=new s(0,-r,0),this.lower_left_corner=this.origin.sub(this.horizontal.mul(.5)).sub(this.vertical.mul(.5)).add(new s(0,0,1))}get_ray(t,e){const n=this.lower_left_corner.add(this.horizontal.mul(t)).add(this.vertical.mul(e)).sub(this.origin);return new L(this.origin,n.normalize())}}const W=document.getElementById("render_canvas"),pt=document.getElementById("debug_canvas"),F=W.getContext("2d"),f=pt.getContext("2d");let B=!1,N=0,R=0,q=0,D=!0;const u=W.width,d=W.height;F.clearRect(0,0,u,d);const U=F.createImageData(u,d);let g=1,T=new Array(u*d).fill(s.zero()),J=new Array(u*d).fill(s.zero());V();const E=U.data,l=K.default(),ft=new _t(90,u/d);function X(){return gt()}let Z=X();addEventListener("keydown",o=>{o.key!=="r"||o.ctrlKey||x()});function V(){T=T.map(()=>s.zero()),J=J.map(()=>s.zero())}function x(){it(),V(),g=1,E.fill(0),F.clearRect(0,0,u,d),Z=X()}function tt(){const o=performance.now(),t=14;for(;performance.now()-o<t;)Z.next().done;F.putImageData(U,0,0),B&&(f.clearRect(0,0,u,d),f.fillStyle="red",f.strokeStyle="rgba(255, 0, 0, 0.5)",f.beginPath(),f.moveTo(0,N),f.lineTo(u,N),f.stroke()),D&&(bt(),D=!1),requestAnimationFrame(tt)}const wt=new lt([new z(new s(0,-201,1),200,new S(new s(.8,.8,.8))),new z(new s(-30,0,55),25,new S(new s(.3,.4,.2).srgb_to_linear())),new z(new s(0,0,3),1,new Y(1.52)),new z(new s(-2.5,0,3),1,new mt(new s(.8,.8,.8),.2)),new z(new s(2.5,0,3),1,new S(s.from_hex(13204165).srgb_to_linear())),new z(new s(0,8,3),2,new ut(new s(1,1,1)))]);function*gt(){for(console.log(`rendering: bounces = ${l.bounces}, samples = ${l.samples}`);;){const o=performance.now();for(let t=0;t<d;t++){B&&(N=t);for(let e=0;e<u;e++){const n=t*u+e,a=dt(e,t,u,d,ft,wt,l);T[n]=T[n].add(a);let r=T[n].div(g);if(B&&e===Math.floor(u/2)&&t===Math.floor(d/2)&&console.log(`sample: ${g}, color: ${r}`),r=r.mul(l.exposure),r=xt(r,l.tone_map),l.gamma_correction){const c=.45454545454545453;r=new s(Math.pow(r.x,c),Math.pow(r.y,c),Math.pow(r.z,c))}r=r.clamp01();const i=(t*u+e)*4;E[i+0]=r.x*255,E[i+1]=r.y*255,E[i+2]=r.z*255,E[i+3]=255,yield}}D=!0,g+=1,R=performance.now()-o,q+=R}}requestAnimationFrame(tt);function xt(o,t){switch(t){case"reinhard":return new s(o.x/(1+o.x),o.y/(1+o.y),o.z/(1+o.z));case"aces":return yt(o);case"none":default:return o}}function yt(o){const i=c=>c*(2.51*c+.03)/(c*(2.43*c+.59)+.14);return new s(i(o.x),i(o.y),i(o.z))}const zt=document.getElementById("render_btn"),b=document.getElementById("bounces_input"),et=document.getElementById("bounces_value"),v=document.getElementById("samples_input"),nt=document.getElementById("samples_value"),M=document.getElementById("exposure_input"),st=document.getElementById("exposure_value"),P=document.getElementById("tone_map_select"),A=document.getElementById("gamma_checkbox"),C=document.getElementById("debug_checkbox"),rt=document.getElementById("accum_frame_span"),H=document.getElementById("last_render_time_span"),O=document.getElementById("average_render_time_span"),at=document.getElementById("total_render_time_span");A.addEventListener("change",()=>{l.gamma_correction=A.checked,x()});C.addEventListener("change",()=>{B=C.checked,f.clearRect(0,0,u,d)});zt.addEventListener("click",x);b.addEventListener("change",()=>{l.bounces=parseInt(b.value),x()});b.addEventListener("input",()=>et.innerText=b.value);v.addEventListener("change",()=>{l.samples=parseInt(v.value),x()});v.addEventListener("input",()=>nt.innerText=v.value);M.addEventListener("change",()=>{l.exposure=parseFloat(M.value),x()});M.addEventListener("input",()=>st.innerText=M.value);P.addEventListener("change",()=>{l.tone_map=P.value,x()});it();function it(){A.checked=l.gamma_correction,C.checked=B,b.value=""+l.bounces,et.innerText=b.value,v.value=""+l.samples,nt.innerText=v.value,M.value=""+l.exposure,st.innerText=M.value,P.value=l.tone_map,q=0,rt.innerText="0",H.innerText="-",O.innerText="-",at.innerText="-"}function bt(){g>1?(H.innerText=`${(R/1e3).toFixed(3)}s`,O.innerText=`${(q/(g-1)/1e3).toFixed(3)}s`):(H.innerText="-",O.innerText="-"),at.innerText=`${(q/1e3).toFixed(3)}s`,rt.innerText=`${g-1}`}
